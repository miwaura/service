やりたいこと
nginxコンテナからphpmyadminコンテナにreverse proxy

1,
https://eset-info.canon-its.jp/malware_info/special/detail/201021.html#:~:text=%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AF%E3%80%81%E7%A4%BE%E5%86%85LAN%E3%81%8B%E3%82%89,%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E4%B8%AD%E7%B6%99%E3%81%99%E3%82%8B%E3%80%82&text=%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E5%8F%8A%E3%81%B3%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%AF,%E8%80%83%E6%85%AE%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AB%E3%81%AA%E3%82%8B%E3%80%82
プロキシ
ユーザー　ー＞　プロキシ　ー＞　インターネット
メリット
　匿名性の確保　社内のパソコンのIPアドレスなどが接続先に公開されない
　キャッシュ　表示の高速化、トラフィックの軽減
　ユーザー認証　ユーザーによってアクセス先の管理
　フィルタリング　
　ウイルス対策　閲覧した際に、受信するコンテンツのウイルスチェック

リバースプロキシ
WEBサーバー　＜ー　リバースプロキシ　＜ー　インターネット
メリット
　リクエスト内容に応じたサーバーの選択　動的コンテンツはAサーバー、静的コンテンツはBサーバー
　負荷分散　同じ処理をするWEBサーバーを複数設置、アクセスを振り分ける
　キャッシュ　WEBサーバーの負荷を軽減
　SSLの高速化　WEBサーバーで行っていたのをリバースプロキシで行い、負荷を軽減

1,
https://qiita.com/schwarz471/items/9b44adfbec006eab60b0
nginx/conf.d/default.conf
location /phpmyadmin {
               proxy_pass http://localhost:5000/phpmyadmin/;
     }
を追加

ー＞ 502
仮説
nginx、phpmyadmin　どちらのコンテナもphpを動かせている
location /phpmyadmin の中にphpの設定を書けば動くのではないか？

2,
include /etc/nginx/fastcgi_params;
fastcgi_read_timeout 3600s;
fastcgi_buffer_size 128k;
fastcgi_buffers 4 128k;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_pass 127.0.0.1:9000;
を追加
ー＞変化　file not found

仮説
phpmyadminのファイルを読む権限がないのではないか？

3,
phpmyadminのコンテナでファイルの権限を777に変更する

chmod 777 usr
chmod 777 share
chmod 777 webapps
ー＞変化なし

仮説
権限を与える場所が間違っている
その他が原因
ひとまずエラ〜ログを見てみる
nginxコンテナ error.log
FastCGI sent in stderr: "Primary script unknown" while reading response header from upstream,
client: 172.18.0.1, server: _, request: "GET /phpmyadmin/ HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: "localhost"

候補
違うサイトを探してみる
エラーから検索する
設定が違う
権限が違う

4,設定が違う
location /phpmyadmin {
               proxy_pass http://localhost:5000/phpmyadmin/;
               ー＞ http://py/phpmyadmin/;
               ー＞ http://py/;
     }
FastCGI sent in stderr: "Primary script unknown" while reading response header from upstream,
 client: 172.18.0.1, server: _, request: "GET /phpmyadmin/ HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: "localhost"

ー＞変化なし

5,
location /phpmyadmin {
               index index.php;
               proxy_pass http://py/;　＜ー　localhost:5000

               include /etc/nginx/fastcgi_params;
               fastcgi_read_timeout 3600s;
               fastcgi_buffer_size 128k;
               fastcgi_buffers 4 128k;
               fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
         #       fastcgi_pass 127.0.0.1:9000;コメントアウト
#    }
phpmyadminの画面に
サーバとクライアントの間にHTTPSの不一致があります。 
これにより、機能しないphpMyAdminまたはセキュリティリスクが発生する可能性があります。 
HTTPSを正しく設定するようにサーバ設定を修正してください
6,
https://www.366service.com/jp/qa/3abfef07da5d6ff2cd0c809c092ed2a7
proxy_set_header X-Forwarded-Proto https;
を追加
ー＞　解決

11/27

やりたいこと
nginx reverse proxyでphpmyadminにアクセス
現状
http://localhost:5000/phpmyadmin/index.php
であればアクセスできる
ログインできる
https://localhost/phpmyadmin/phpmyadmin/index.php
nginxコンテナからreverse proxyだと
phpmyadminのログイン画面までは表示される
ログインすると
not found　404
となってしまう

11:57
わからないこと
reverse proxy の際、どちらのwebサーバーが返信しているのか？
pyのnginxを止めてみる
nginxコンテナからアクセスすると502->処理はphpmyadminコンテナで行われているのだろう


候補
グローバルスラック
４２のスタックオーバーフロー
違うサイトを探してみる
エラーから検索する
設定が違う
権限が違う
人に聞く

11/28
9:44
現状
php動いているが
pmaにログインすると404 not foudnになる
1,
グローバルスラック
          proxy_redirect     off;
          proxy_set_header   Host $host;
          proxy_set_header   X-Real-IP $remote_addr;
          proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header   X-Forwarded-Host $server_name;
->変化なし

2,
https://teratail.com/questions/43399
fastcgi_split_path_info  ^/phpMyAdmin/(.+\.php)(.*)$; 
->変化なし